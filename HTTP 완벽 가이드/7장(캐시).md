## 캐시

캐시는 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치다.

> 6장에서 배운 프락시에서 캐시 프락시를 이용하면, 원 서버에 접근하지 않고 캐시 프락시에 접근하여 리소스를 가져올 수 있다고 배웠다.

### 캐시의 장점
  
- 불필요한 데이터 전송을 줄여, 네트워크 요금 비용이 줄어든다.
- 네트워크 병목을 줄여준다.
  - 대역폭을 늘리지 않고도 페이지를 빨리 불러 올 수 있다.
- 원 서버에 대한 요청을 줄여준다.
  - 서버는 부하를 줄일 수 있으며 더 빨리 응답할 수 있게 된다.
- 거리로 인한 지연을 줄여준다.(가까운곳에서 리소스를 가져오기 때문)
- 캐시는 광역 통신망의 제한된 대역폭으로 인한 병목을 개선할 수 있다.

### 갑작스런 요청 쇄도(Flash Crowds)

캐싱은 갑작스런 요청 쇄도에 대처하기 위해 특히 중요하다. 갑작스런 사건(뉴스, 속보, 기사, 연예인 사건 등)으로 인해 많은 사람이 거의 동시에
웹 문서에 접근할 때 `갑작스런 요청 쇄도(Flash Crowds)`가 발생한다.

Flash Crowds가 발생하면 트래픽양이 급증하게되어 웹 서버의 심각한 장애를 야기시킨다.

### 거리로 인한 지연

대역폭이 문제가 되지 않더라도 거리가 문제가 될 수 있다.

### 적중과 부적중

캐시가 세상 모든 문서의 사본을 저장하지는 않는다. 

- `(순수) 캐시 적중(cache hit)`
  - 캐시에 요청이 도착했을 때, 그에 대응하는 사본이 존재하면 그것을 이용해 요청이 처리 될 수 있다.
- `캐시 부적중(cache miss)`
  - 캐시에 대응하는 사본이 없으면, 원 서버로 전달된다.
  
### 재검사(Revalidation)

원 서버의 리소스는 변경될 수 있기 때문에, 캐시는 반드시 그들이 갖고 있는 사본이 여전히 최신인지 서버를 통해 때때로 점검해야 한다.
이러한 신선도 검사를 `HTTP Revalidation(HTTP 재검사)`라고 한다.

클라이언트에서 캐시로 사본 요청시 충분히 오래된 리소스에 대해서만 신선도 검사, 재검사를 실시한다.

- `재검사 적중(느린 적중)`
  - 원 서버로부터 객체 데이터를 받아올 필요가 없다.
  - 재검사 필요?
    - 원 서버에 재검사 요청 보냄
      - 콘텐츠(리소스)가 변경되지 않았으면 `304 Not Modified` 응답을 보냄
        - 캐시는 사본이 신선하다는 것을 알았으므로, 표시를 해둔뒤에 클라이언트로 응답을 보냄
        
### 재검사 적중 vs 순수 캐시적중 vs 캐시 부적중 속도비교

순수 캐시적중 > 재검사 적중 > 캐시 부적중 = 재검사 부적중

재검사 적중은 서버로 부터 객체를 받아올 필요는 없기 때문에, 캐시 부적중 보다 빠르다.

재검사 부적중은 신선도 검사 결과가, 유효기간이 지났다고 판정됬을 때를 뜻한다. 이 경우에는 원 서버에서 객체를 받아와야 하기 때문에 캐시 부적중과
속도가 비슷하다.

### If-Modified-Since 헤더

HTTP는 캐시된 객체를 확인하기 위해 몇가지 도구를 제공하는데, 그 중 가장 많이 쓰이는것은 If-Modified-Since 헤더이다. 

GET 요청을 보낼때 If-Modified-Since 헤더를 추가하면 `캐시된 시간 이후에 변경된 경우에만 사본을 보내달라는 의미가 된다.`

GET If-Modified-Since 요청이 서버에 도착했을때 일어날 수 있는 세가지 경우

1. 서버 콘텐츠가 변경되지 않은 경우
  - 재검사 적중(서버가 304 Not Modified 응답을 보냄)
2. 서버 콘텐츠가 변경된 경우
  - 재검사 부적중(캐시된 사본과, 서버의 콘텐츠가 다른경우, 서버는 콘텐츠 전체(JSON 객체)와 함께 평범한 HTTP 200 OK 응답을 클라이언트에게 보낸다.)
3. 객체가 삭제된 경우
  - 서버는 404 Not Found 응답을 보내며, 캐시는 사본을 삭제한다.
  
### 캐시 적중률

캐시가 요청을 처리하는 비율을 캐시 적중률(캐시 적중비, 문서 적중률, 문서 적중비)라고 한다. 적중률은 0~1까지의 값으로 퍼센트로 표현할 수 도 있다.

- 0% 
  - 모든 요청이 캐시 부적중
- 100%
  - 모든 요청이 캐시 적중
  
 캐시 적중률이 40%정도 되면 웹 캐시로 괜찮은 편이다.
 
### 바이트 적중률

바이트 단위 적중률은 캐시를 통해 제공된 모든 바이트의 비율을 표현한다. 이 측정값은 트래픽이 절감된 정도를 포착해낸다.

적중률 100%는 모든 바이트가 캐시에서 왔으며, 어떤 트래픽도 인터넷으로 나가지 않았음을 의미한다.

### 적중과 부적중 구별

- via 헤더에 추가정보 붙이기
- Date 헤더 이용
  - 응답의 Date 헤더 값을 현재 시각과 비교하여, 응답의 생성일이 더 오래되었다면 클라이언트는 응답이 캐시된 것임을 알아낼 수 있다.
- Age 헤더 이용

## 캐시 토폴로지

한 사람에게만 할당된 캐시를 `개인 전용 캐시(private cache)`라고 한다.

여러 사람에게 공유된 캐시를 `공용 캐시(public cache)`라고 한다.

### private cache

웹 브라우저는 개인 전용 캐시를 내장하고 있다. 대부분의 브라우저는 자주 쓰이는 문서를 개인용 컴퓨터의 디스크와 메모리에 캐시해 놓고, 사용자가
캐시 사이즈와 설정을 수정할 수 있도록 허용한다.

캐시보는 방법은 익스의 경우 `도구 > 인터넷 옵션 > 검색 기록 > 설정 > 파일보기`에서 볼 수 있다.

크롬의 경우 특별한 URL인 `about:cache`ㅁ를 통해 연결되는 페이지에서 캐시 콘텐츠의 목록을 볼 수 있다.

### public cache

공용 캐시를 프락시 캐시, 캐시 프락시 서버 라고 부른다. 

프락시 캐시는 로컬 캐시에서 문서를 제공하거나, 혹은 사용자의 입장에서 서버를 제공한다. 공용 캐시는 여러 사용자가 접근하기 때문에, 불필요한 트래픽을
줄일 수 있는 더 많은 기회가 있다.


