# HTTP/2.0

HTTP/1.1 메시지 교환 방식은 커넥션 하나를 통해 요청 하나를 보내고 그에 대해 응답 하나만을 받는 방식인데, 이 방식의 문제점은 응답을 받아야만 그 다음 요청을 보낼 수 있기 때문에
심각한 `회전 지연(latency)`을 피할 수 없었다. 이 문제를 회피하기 위해 `병렬 커넥션`이나 `파이프라인 커넥션`이 도입되었지만 성능 개선에 대한 근본적인 해결책은 되지 못했다.

## 개요

HTTP/2.0은 서버와 클라이언트 사이의 `TCP 커넥션` 위에서 동작한다. 이때 TCP 커넥션을 초기화 시키는 것은 클라이언트이다.

HTTP/2.0의 요청과 응답은 길이가 정의된(최대 16383바이트) 한 개 이상의 프레임에 담긴다. 이때 HTTP 헤더는 압축되어 담긴다.

`프레임`들에 담긴 요청과 응답은 `스트림`을 통해 보내진다. 한 개의 스트림이 한 쌍의 요청과 응답을 처리한다.

하나의 커넥션 위에 여러 개의 스트림이 동시에 만들어질 수 있으므로, 여러 개의 요청과 응답을 동시에 처리하는 것 역시 가능하다.

> 즉, HTTP/2.0 프로토콜은 TCP 커넥션 위에서 작동하며, 커넥션 내부에는 여러개의 스트림이 있는데 하나의 스트림은 한 쌍의 요청과 응답(프레임)을 처리한다.
모든 메시지는 프레임에 담겨 전송된다.

HTTP/2.0은 기존의 요청 응답과는 약간 다른 새로운 상호작용 모델인 `서버 푸시`를 도입했다. 이를 통해 서버는 클라이언트에게 필요하다고 생각하는 리소스라면
그에 대한 요청을 명시적으로 받지 않더라도 능동적으로 클라이언트에게 보내줄 수 있다.

HTTP/2.0은 요청과 응답 메시지의 의미를 HTTP/1.1과 같도록 유지하고 있다. 단 `Content-Length` 헤더 이름은 `:content-length`가 되었으며, 상태줄을 통해
표현하던 `404 Not Found는 404 값을 가지고 있는 `:status` 헤더로 표현하게 되었다.

## 스트림

스트림은 HTTP/2.0 커넥션을 통해 클라이언트와 서버 사이에서 교환되는 프레임들의 독립된 양방향 시퀀스이다.

요청을 받은 서버는 그 요청과 같은 스트림으로 응답을 보낸다. 그리고나면 스트림이 닫히게 된다. HTTP/1.1 에서는 한 TCP 커넥션을 통해 요청을 보냈을 때, 그에 대한 응답이 도착하고 나서야 같은 TCP 커넥션으로 다시 
요청을 보낼 수 있다. 따라서 회전지연이 발생한다.

하지만 HTTP/2.0은 하나의 커넥션에 여러개의 스트림이 동시에 열릴 수 있다. 따라서 하나의 HTTP/2.0 커넥션을 통해 여러 개의 요청이 동시에 보내질 수 있기 때문에
이 문제는 쉽게 해결될 수 있다.

또한 스트림은 우선순위도 가질 수 있다. 예를들어 중요한 리소스를 담고 있는 스트림에게 더 높은 우선순위를 부여하여 빨리 도착하도록 할 수 있다.
하지만 요청이 우선순위대로 처리된다는 보장은 없다.

## 헤더압축

HTTP/1.1에서 헤더는 아무런 압축 없이 그대로 전송되었다. 과거에는 웹 페이지 하나를 방문할 때의 요청이 많지 않아서 상관없었지만, 지금은 수십에서 수백 번의 요청을
보내기 때문에, `헤더의 크기가 회전 지연(latency)과 대역폭 양쪽 모두에 실질적인 영향을 끼치게 되었다.`

이를 개선하기 위해 HTTP/2.0에서는 HTTP 메시지의 헤더를 압축하여 전송한다. 헤더는 `HPACK` 명세에 정의된 헤더 압축 방법으로 압축된 뒤 `헤더 블록 조각`
으로 쪼개져서 전송된다. 받는 쪽에서는 이 조각들을 이은 뒤 압축을 풀어 원래의 헤더 집합으로 복원한다.

`HPACK`은 헤더를 압축하고 해제할 때 `압축 콘텍스트(compression context)`를 사용한다.

## 서버 푸시

HTTP/2.0은 서버가 하나의 요청에 대해 응답으로 여러 개의 리소스를 보낼 수 있도록 해준다. 이 기능은 서버가 클라이언트에서 어떤 리소스를 요구할 것인지
미리 알 수 있는 상황에서 유용하다. 

예를들어 HTML 문서를 요청받은 서버는 그 HTML 문서가 링크하고 있는 이미지, CSS 파일, 자바스크립트 파일 등의 리소스를 클라이언트에게 푸시할 수 있을 것이다. 
이는 클라리언트가 HTML 문서를 파싱해서 필요한 리소스를 다시 요청하여 발생하게 되는 트래픽과 회전 지연을 줄여준다.

리소스를 푸시하려는 서버는 먼저 클라이언트에게 자원을 푸시할 것입을 `PUSH_PROMISE` 프레임을 보내어 미리 알려주어야 한다. 클라이언트가 `PUSH_PROMOISE`
프레임을 받게 되면 해당 프레임으 스트림은 클라이언트 입장에서는 `예약됨(원격)` 상태가 된다. 이 상태에서 클라이언트는 `RST_STREAM` 프레임을 보내어
푸시를 거절할 수 있다. `RST_STREAM`을 보내게 되면 그 스트림은 즉각 닫히게 된다.
